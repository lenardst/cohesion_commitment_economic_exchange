{{ block title }}Negotiation{{ endblock }}
{{ block content }}

    <p>
    Please send offers to other participants and respond to the offers of others to trade.
    </p>

    <p> You have received <b>{{C.UNIT_BUDGET}} units</b> for this round. Your potential pay-off is displayed next to the offers. If you do not trade, your pay-off will be 0.20 €.
    </p>

    <div id="reputation">
        <table id="reputation_table">
  <tr>
    <th>Participant</th>
      <th>Select for Offer <div class="tooltip" style="z-index: 6"><b>i</b>
  <span class="tooltiptext">Use the buttons to select a participant you want to send an offer to. Next, chose and send the offer below the table.</span>
</div></th>
    <th>Average difference between agreed and sent units <div class="tooltip" style="z-index: 5"><b>i</b>
  <span class="tooltiptext">This column shows the average difference between agreed and sent units for the respective participant. A positive number means that a participant has sent more than agreed in the past. A negative number means that a participant has sent less than agreed in the past.</span>
</div></th>
    <th>List of differences between agreed and sent units <div class="tooltip" style="z-index: 4"><b>i</b>
  <span class="tooltiptext">This column shows the list of differences between agreed and sent units for the respective participant. A positive number means that a participant sent more than agreed. A negative number means that this participant sent less than agreed. The difference from the first trade is listed first and the most recent one is listed last.</span>
</div></th>
      <th>Offers from other participants <div class="tooltip" style="z-index: 3"><b>i</b>
  <span class="tooltiptext">This column shows the offers you have received from other participants. You can accept or decline the offer in the right column.</span> </div></th>
      <th>Accept/decline sent offers <div class="tooltip" style="z-index: 2"><b>i</b>
  <span class="tooltiptext">In this column, you can accept or decline offers from other participants. Once you accept an offer, you cannot change your trade anymore. If you agreed to a trade, all your pending offers will be closed.</span> </div></th>
      <th>Offers to other participants <div class="tooltip" style="z-index: 1"><b>i</b>
  <span class="tooltiptext">This column shows the offers you have sent to other participants. If they decline the offer, it will disappear from this column, and you can send another one. If they accept the offer, you cannot change your trade anymore and all your pending offers will be closed.</span></div></th>
  </tr>
        {{ for reputation in reputation_list }}
    <tr>
        <td>Participant {{ reputation.player.label }}</td>
        <td><button type="button" id="select-button{{ reputation.player.number }}" class="select-button" onclick="selectRecipient({{ reputation.player.number }})" disabled>Select participant {{ reputation.player.label }}</button></td>
        <td>{{ reputation.reputation_mean }} </td>
        <td>{{ reputation.reputation_list }}</td>
        <td id="received-cell-{{ reputation.player.number }}" class="received-cell"></td>
        <td id="feedback-cell-{{ reputation.player.number }}" class="feedback-cell"></td>
        <td id="sent-cell-{{ reputation.player.number }}" class="sent-cell"></td>
    </tr>
        {{ endfor }}
            </table>
    </div>

    <hr>
    <div id="negotiation">
        <p><b>Send offers</b> <span class="tooltip"><b>i</b>
      <span class="tooltiptext">Send an offer by selecting a participant, choosing an amount and clicking the button below. The offered and the demanded amount always add up to {{C.UNIT_BUDGET}}.</span>
</span></p>
    <p id="sendOffer">
        <b><span id="display-recipient"></span></b>
        <input type="hidden" name="recipient" id="recipient" min="1" max="6">
        <table id="slider_table">
            <tr>
                        <td style='border:none;' class="quant-cell-left">You receive: <br><span id="left">10 (Your pay-off: 0.30 €)</span></td>
                        <td style='border:none;' class="quant-cell-right">The other receives: <br><span id="right">10 (Other's pay-off: 0.30 €)</span></td>
            </tr>
            <tr>
                        <td style='border:none;' colspan="2" id="slider-cell"><input type="range" id="offer" class="offer-slider" name="slider" min="0" max="20" value="10" step="1"></td>
            </tr>
                </table>
        <input type="button" value="Send offer" id="button_send" disabled>
            </div>

    <p id="display-exchange"> </p>

{{ endblock }}

{% block scripts %}
<script>
    const form = document.getElementById('sendOffer');
    document.getElementById('button_send').onclick = sendOffer;
    const received_table = document.getElementById('received_table')
    const sent_table = document.getElementById('sent_table')
    const player_colors = js_vars.player_colors
    const player_order = js_vars.player_order
    window.onload = liveSend('R');


    function sendOffer(event) {
        let recipient = document.getElementById('recipient').value;
        let offer = document.getElementById('offer').value;
        let demand = 20 - offer;
        liveSend(['O',recipient, offer, demand]); // O for create offer
    }

    function liveRecv(data) { // First list item of data is the type of action
        console.log(data)
        if (data[0] == 'R') {
            displayPlayers(data[1]);
            displayPendingOffers(data[2]);
            displayOpenOffers(data[3]);
        } else if (data[0] == 'A') { // Offer accepted
            displayExchange(data[1], data[2], data[3]);
        } else if (data[0] == 'N') { // All players agreed
            document.getElementById("form").submit();
        } else if (data[0] == 'E'){
            alert(data[1]);
        }
    }

    function displayPendingOffers(offer_list){
        var list1 = document.getElementsByClassName("sent-cell");
        for (i = 0; list1.length > i; i++) {
            list1[i].innerHTML = ""
        }
        for (i = 0; offer_list.length > i; i++){
            cell_offer = document.getElementById('sent-cell-' + offer_list[i][1]);
            var pay_off = js_vars.pay_traded_unit * offer_list[i][3] + js_vars.pay_budget_unit * offer_list[i][3];
            var pay_off_partner = js_vars.pay_traded_unit * offer_list[i][2] + js_vars.pay_budget_unit * offer_list[i][2];
            cell_offer.innerHTML = 'You receive ' + offer_list[i][3] + ' (' + pay_off.toFixed(2) + '€)' + ', the other receives ' + offer_list[i][2] + ' (' + pay_off_partner.toFixed(2) + '€)';
        }
    }

    function displayOpenOffers(offer_list) {
        var list1 = document.getElementsByClassName("received-cell");
        var list2 = document.getElementsByClassName('feedback-cell');
        for (i = 0; list1.length > i; i++) {
            list1[i].innerHTML = ""
            list2[i].innerHTML = ""
        }

        for (i=0; offer_list.length > i; i++) {
            cell_offer = document.getElementById('received-cell-' + offer_list[i][1]);
            cell_accept_decline = document.getElementById('feedback-cell-' + offer_list[i][1]);
            var pay_off = js_vars.pay_traded_unit * offer_list[i][2] + js_vars.pay_budget_unit * offer_list[i][2];
            var pay_off_partner = js_vars.pay_traded_unit * offer_list[i][3] + js_vars.pay_budget_unit * offer_list[i][3];
            cell_offer.innerHTML = 'You receive ' + offer_list[i][2] + ' (' + pay_off.toFixed(2) + '€)' + ', the other receives ' + offer_list[i][3] + ' (' + pay_off_partner.toFixed(2) + '€)';
            cell_accept_decline.innerHTML = '<button type="button" id="accept_' + offer_list[i][0] + '" onclick="acceptOffer(' + offer_list[i][0] + ')">Accept</button><br><button type="button" id="decline_' + offer_list[i][0] + '" onclick="declineOffer(' + offer_list[i][0] + ')">Decline</button>';
        }
    }

    function declineOffer(offer_id){
        // Send to server
        liveSend(['D', offer_id]) // D for decline
    }

    function acceptOffer(offer_id){
        // Send to server
        liveSend(['A', offer_id]); // A for accept
    }

   function displayPlayers(player_list){
        var buttons = document.getElementsByClassName('select-button')
        for(var i = 0; i < buttons.length; i++) {
            buttons[i].disabled = true;
            buttons[i].classList.remove('active-select-button');
        }
        $.each(player_list, function(index, number){
            document.getElementById('select-button' + number).removeAttribute('disabled')
        });
        if (document.getElementById('recipient').value == ""){
            document.getElementById('display-recipient').innerHTML = "Please select a participant from the table above.";
        } else if (!player_list.includes(document.getElementById('recipient').value)){
            document.getElementById('recipient').value = "";
            document.getElementById('display-recipient').innerHTML = "Please select another participant.";
            document.getElementById('button_send').disabled = true;
        }
    }

    function displayExchange(partner, send, receive){
        document.getElementById('reputation').style.display = 'none';
        document.getElementById('negotiation').style.display = 'none';
        document.getElementById('display-exchange').innerHTML = 'You have agreed with participant ' + player_colors[player_order.indexOf(partner)] + ' to send ' + send + ' units and to receive ' + receive
+ ' units.'}

    document.getElementById('offer').addEventListener('input', changeDemand)
    function changeDemand(){
        var demand = document.getElementById('offer').value;
        var offer = 20 - demand;
        var pay_off = js_vars.pay_traded_unit * demand + js_vars.pay_budget_unit * demand;
        var pay_off_partner = js_vars.pay_traded_unit * offer + js_vars.pay_budget_unit * offer;
        document.getElementById('right').innerHTML = offer + ' (Other\'s pay-off: ' + pay_off_partner.toFixed(2) + ' €)';
        document.getElementById('left').innerHTML = demand + ' (Your pay-off: ' + pay_off.toFixed(2) + ' €)';
    }

    function selectRecipient(number) {
        var active_button = document.getElementsByClassName('active-select-button')[0];
        if(active_button != null){
            active_button.classList.remove('active-select-button')
        }
        document.getElementById('select-button' + number).classList.add('active-select-button');
        document.getElementById("recipient").value = number;
        document.getElementById("display-recipient").innerHTML = "You selected participant " + player_colors[player_order.indexOf(number)] + ".";
        document.getElementById('button_send').removeAttribute('disabled');
}


</script>
{{ endblock }}

{% block style %}
<style>
  #reputation_table{
    display: flex;
    flex-direction: row;
      text-align: center;
  }

   td, th, tr {
    border: 1px solid black;
    padding: 5px;
  }

.container {
  grid-template-columns: 1fr 1fr; /* Two columns with equal width */
}

.full-block {
    float: none;
    display: inline-block;
}

.offer-slider {
  width: 400px;
}

#button_send {
    margin-top: 10px;
    width: 400px;
}

.quant-cell-right{
    text-align: right;
}

.width200 {
    width: 250px;
}

  .otree-timer.alert.alert-warning {
    padding: 5px 5px !important;
      padding-left: 5px;
}

.otree-timer.alert.alert-warning > p {
    margin-bottom: 0px !important;
}

.tooltip {
  position: relative;
  display: inline-block;
  border-bottom: 1px dotted black;
    opacity: 1;
    color: white;
    border-color: green;
    background-color: green;
    padding: 1px 5px;
    border-radius: 10px;
    z-index: 1;
}

.tooltiptext {
  visibility: hidden;
  width: 200px;
  background-color: black;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 5px 5px;

  /* Position the tooltip */
  position: absolute;
  z-index: 2;
  top: -5px;
  left: 105%;
}

.tooltip:hover .tooltiptext {
  visibility: visible;
}

.active-select-button {
        background-color: #72b2ff;
}

</style>
{{ endblock }}

